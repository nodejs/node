#!/bin/bash

# By running android-configure with source, will allow environment variables to
# be persistent in current session. This is useful for installing native node
# modules with npm. Also, don't forget to set the arch in npm config using
# 'npm config set arch=<arch>'

ARCH=aarch64
DEST_CPU=arm64
SUFFIX="$ARCH-linux-android"
TOOLCHAIN_NAME="$SUFFIX"


# Add the standalone toolchain to the search path.
# toolchain='/home/a/android-ndk-r19c/toolchains/aarch64-linux-android-4.9/prebuilt/linux-x86_64'
toolchain='/home/a/android-ndk-r19c/toolchain'
export PATH="$PATH:$toolchain:/bin"
export toolchain_bin="$toolchain/bin"

# Tell configure what tools to use.
target_host=$toolchain_bin/aarch64-linux-android
export AR=$target_host-ar
export AS=$target_host-clang
export CC=$target_host-clang
export CXX=$target_host-clang++
export LD=$target_host-ld
export STRIP=$target_host-strip

# Tell configure what flags Android requires.
export CFLAGS="-fPIE -fPIC -static-libstdc++"
#export CFLAGS="-fPIE -fPIC -static-libstdc++ -I$toolchain/sysroot/usr/include"
export LDFLAGS="-pie"


GYP_DEFINES="target_arch=$ARCH"
GYP_DEFINES+=" v8_target_arch=$DEST_CPU"
GYP_DEFINES+=" android_target_arch=$ARCH"
GYP_DEFINES+=" host_os=linux OS=android"
export GYP_DEFINES

if [ -f "configure" ]; then
    ./configure \
        --dest-cpu=$DEST_CPU \
        --dest-os=android \
        --without-intl \
        --without-snapshot \
        --openssl-no-asm \
        --cross-compiling \
        --enable-static
fi
